{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>News Hub</title>
    <link rel="stylesheet" href="{% static 'css/news_hub.css' %}" />
</head>

<body>
    <div class="news-hub-container">
        <p>AI News Hub</p>

       <section style="
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 12px;
    padding: 12px 16px;
    background: #f8f9fa;
    border-bottom: 1px solid #ddd;
    color: #222;
    font-family: Arial, sans-serif;
">
    <!-- Left: Title + Form -->
    <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
        <p style="font-weight:bold; font-size:18px; margin:0; color:#000;">Your News Feed: World & Local</p>
        <form method="get" id="category-form">
            <select name="category" id="news-category" style="
                padding: 10px;
                font-size: 16px;
                border-radius: 6px;
                border: 1px solid #666;
                background: #fff;
                color: #222;
                cursor: pointer;
                width: 220px;
            " onchange="document.getElementById('category-form').submit();">
                <option value="">-- All News --</option>
                <option value="world">World News</option>
                <option value="local">Local News</option>
            </select>
        </form>
    </div>

    <!-- Middle: Custom Dropdown -->
    <div class="category-select-wrapper" id="category-wrapper">
        <p id="category-label" style="margin:0; font-weight:bold; color:#333;">News Category</p>
        <div class="custom-dropdown" id="category-dropdown" style="
            background:#fff; 
            border:1px solid #ccc;
            border-radius:6px;
            padding:6px 10px;
            color:#222;
        ">
            <div class="dropdown-selected">-- Select News Category --</div>
            <ul class="dropdown-options" tabindex="0" style="
                background:#fff;
                border:1px solid #ccc;
                border-radius:6px;
                padding:8px;
                max-height:200px;
                overflow-y:auto;
            ">
                <li>Politics</li>
                <li>Technology</li>
                <li>Science</li>
                <li>Health</li>
                <li>Business</li>
                <li>Economy</li>
                <li>Education</li>
                <li>Sports</li>
                <li>Entertainment</li>
                <li>Music</li>
                <li>Movies</li>
                <li>Art & Culture</li>
                <li>Religious</li>
                <li>Travel</li>
                <li>Weather</li>
                <li>World</li>
                <li>Environment</li>
                <li>Crime</li>
                <li>Military</li>
                <li>Legal</li>
                <li>Local</li>
                <li>Opinion</li>
            </ul>
        </div>
    </div>

    <!-- Right: Links -->
    <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
        <a href="#" style="
            padding:8px 14px;
            background:#007bff;
            color:#fff;
            border-radius:6px;
            font-weight:bold;
            text-decoration:none;
            transition:all 0.2s ease;
        " onmouseover="this.style.background='#0056b3'; this.style.boxShadow='0 2px 6px rgba(0,0,0,0.2)';"
          onmouseout="this.style.background='#007bff'; this.style.boxShadow='none';">
          Chat With AI
        </a>

        <a href="{% url 'submit_contact' %}" class="contact-link" style="
            padding:8px 14px;
            background:#28a745;
            color:#fff;
            border-radius:6px;
            font-weight:bold;
            text-decoration:none;
            transition:all 0.2s ease;
        " onmouseover="this.style.background='#1e7e34'; this.style.boxShadow='0 2px 6px rgba(0,0,0,0.2)';"
          onmouseout="this.style.background='#28a745'; this.style.boxShadow='none';">
          Contact Us
        </a>

        <a href="#" style="
            padding:8px 14px;
            background:#dc3545;
            color:#fff;
            border-radius:6px;
            font-weight:bold;
            text-decoration:none;
            transition:all 0.2s ease;
        " onmouseover="this.style.background='#a71d2a'; this.style.boxShadow='0 2px 6px rgba(0,0,0,0.2)';"
          onmouseout="this.style.background='#dc3545'; this.style.boxShadow='none';">
          Add News
        </a>
    </div>
</section>


        <!-- Search Bar -->
        <section>
            <form method="GET">
                <input type="text" name="q" placeholder="Search news..." />
                <button type="submit">Search</button>
            </form>
        </section>

        <!-- News List as Cards -->
        <section class="news-cards-container">
            {% for new in news %}
            <div class="news-card">
                {% if new.file %}
                <div class="news-image">
                    {% if new.file_type == 'video' %}
                    <video autoplay muted loop playsinline class="clickable-media" data-type="video"
                        data-src="{{ new.file.url }}" data-ext="{{ new.video_ext }}">
                        <source src="{{ new.file.url }}" type="video/{{ new.video_ext }}">
                        Your browser does not support the video tag.
                    </video>
                    {% elif new.file_type == 'image' %}
                    <img src="{{ new.file.url }}" alt="{{ new.heading }}" class="clickable-media" data-type="image"
                        data-src="{{ new.file.url }}">
                    {% endif %}
                </div>
                {% endif %}
                <div class="news-content">
                    <h3 class="news-title">{{ new.heading }}</h3>
                    <p class="news-description">{{ new.description|truncatechars:150 }}</p>
                    <div class="news-footer">
                        <a href="{% url 'news_detail' new.pk %}" class="see-more-btn">See More</a>
                        <p class="news-author">By {{ new.author }}</p>
                    </div>
                </div>
            </div>
            {% empty %}
            <p class="no-news-message">No news articles found.</p>
            {% endfor %}
        </section>

      <!-- Bottom AI Chat Section -->
<div id="ai-chat" style="
    position: fixed;
    bottom: 0;
    right: 20px;
    width: 300px;
    max-height: 400px;
    border: 1px solid #ccc;
    border-radius: 10px 10px 0 0;
    background: white;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
">
    <div id="chat-header" style="padding: 10px; background:#007bff; color:white; border-radius: 10px 10px 0 0;">
        News AI Assistant
    </div>
    <div id="chat-messages" style="flex:1; padding:10px; overflow-y:auto;"></div>
    <div style="display:flex; border-top:1px solid #ccc;">
        <input id="chat-input" type="text" placeholder="Ask about news..." style="flex:1; padding:10px; border:none; outline:none;">
        <button id="chat-send" style="padding:10px; background:#007bff; color:white; border:none; cursor:pointer;">Send</button>
    </div>
</div>

<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

        <!-- Full News Modal -->
        <div id="fullNewsModal" class="media-modal" style="display: none;">
            <div class="media-modal-content">
                <span id="modalCloseFull" class="modal-close">&times;</span>
                <div id="fullNewsContainer">
                    <h3 id="fullNewsTitle"></h3>
                    <p id="fullNewsDescription"></p>
                    <p id="fullNewsAuthor" style="margin-top: 20px; font-weight: bold;"></p>
                </div>
            </div>
        </div>

        <!-- Modal / Pane -->
        <div id="mediaModal" class="media-modal" style="display:none;">
            <div class="media-modal-content">
                <span id="modalClose" class="modal-close">&times;</span>
                <div id="modalMediaContainer"></div>
            </div>
        </div>

        <!-- Footer -->
        <section>
            <p>&copy; Drav-Viv 2025</p>
        </section>

    </div>

    <!-- JS Section -->
    <script>
document.addEventListener("DOMContentLoaded", function () {
    // --- Dropdown Logic ---
    const wrapper = document.getElementById('category-wrapper');
    const dropdown = document.getElementById('category-dropdown');
    const selected = dropdown?.querySelector('.dropdown-selected');
    const options = dropdown?.querySelectorAll('.dropdown-options li');
    const label = document.getElementById('category-label');

    let hoverTimeout = null;

    if (label) {
        label.addEventListener('click', () => {
            wrapper.classList.toggle('open');
        });
    }

    if (selected) {
        selected.addEventListener('click', () => {
            wrapper.classList.toggle('open');
        });
    }

    if (wrapper) {
        wrapper.addEventListener('mouseenter', () => {
            clearTimeout(hoverTimeout);
            wrapper.classList.add('open');
        });

        wrapper.addEventListener('mouseleave', () => {
            hoverTimeout = setTimeout(() => {
                wrapper.classList.remove('open');
            }, 200);
        });
    }

    document.addEventListener('click', (e) => {
        if (wrapper && !wrapper.contains(e.target)) {
            wrapper.classList.remove('open');
        }
    });

    if (options) {
        options.forEach(option => {
            option.addEventListener('click', () => {
                selected.textContent = option.textContent;
                wrapper.classList.remove('open');
                const select = document.getElementById('news-category');
                if (select) {
                    select.value = option.getAttribute('data-value') || option.textContent.toLowerCase();
                    select.dispatchEvent(new Event('change'));
                }
            });
        });
    }

    // --- AI Chat Logic ---
    const chatInput = document.getElementById('chat-input');
    const chatSend = document.getElementById('chat-send');
    const chatMessages = document.getElementById('chat-messages');
    const select = document.getElementById('news-category');

    function appendMessage(user, text, time=null) {
        const div = document.createElement('div');
        div.style.marginBottom = '8px';
        div.innerHTML = `<b>${user}:</b> ${text} ${time ? `<small style="color:gray;">(${time})</small>` : ""}`;
        chatMessages.appendChild(div);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    async function sendMessage() {
    const message = chatInput.value.trim();
    if (!message) return;
    appendMessage('You', message);
    chatInput.value = '';

    const category = select ? select.value : null;

    try {
        const res = await fetch("/chat_ai/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]')?.value || ""
            },
            body: JSON.stringify({ message: message, category: category })
        });

        const data = await res.json();

        if (data.reply) {
            appendMessage('AI', data.reply);
        } else if (data.error) {
            appendMessage('AI', `⚠️ Error: ${data.error}`);
        } else {
            appendMessage('AI', 'No response from AI.');
        }

        // ✅ Give DB a very short time, then reload fresh history
        setTimeout(() => {
            loadChatHistory();   // reuse your existing function
        }, 300);  // 0.3 seconds is enough

    } catch (err) {
        console.error("Error fetching AI response:", err);
        appendMessage('AI', '⚠️ Sorry, something went wrong.');
    }
}

    chatSend.addEventListener('click', sendMessage);
    chatInput.addEventListener('keypress', e => { if (e.key === 'Enter') sendMessage(); });

    select?.addEventListener('change', () => {
        console.log("Selected category:", select.value);
    });

    // Helper: Render chat bubble
function renderChatMessage(sender, text, time, source = null) {
    const chatBox = document.getElementById("chat-messages");
    const msgWrapper = document.createElement("div");
    msgWrapper.style.display = "flex";
    msgWrapper.style.marginBottom = "8px";
    msgWrapper.style.justifyContent = sender === "You" ? "flex-end" : "flex-start";

    const bubble = document.createElement("div");
    bubble.style.maxWidth = "70%";
    bubble.style.padding = "8px 12px";
    bubble.style.borderRadius = "15px";
    bubble.style.wordWrap = "break-word";
    bubble.style.fontSize = "14px";

    // Style depending on sender
    if (sender === "You") {
        bubble.style.background = "#007bff";
        bubble.style.color = "white";
        bubble.style.borderBottomRightRadius = "3px";
    } else {
        bubble.style.background = "#e5e5ea";
        bubble.style.color = "black";
        bubble.style.borderBottomLeftRadius = "3px";
    }

    bubble.innerHTML = `
        ${source ? `<div style="font-size:11px; font-weight:bold; margin-bottom:4px;">${source}</div>` : ""}
        <div>${text}</div>
        <div style="font-size:10px; margin-top:4px; text-align:right; opacity:0.7;">
            ${time}
        </div>
    `;

    msgWrapper.appendChild(bubble);
    chatBox.appendChild(msgWrapper);
    chatBox.scrollTop = chatBox.scrollHeight; // auto scroll
}

// --- Load Previous Chat History ---
async function loadChatHistory() {
    try {
        const res = await fetch("/get_chat_history/");
        const data = await res.json();

        if (data && data.length > 0) {
            data.forEach(chat => {
                console.log("Loaded chat:", chat); // 👀 See what comes back
                renderChatMessage("You", chat.user_message, chat.created_at, "User");
                renderChatMessage("AI", chat.ai_response, chat.created_at, chat.source || "AI");
            });
        }
    } catch (err) {
        console.error("Error loading chat history:", err);
    }
}

loadChatHistory(); // ✅ run on page load

    // --- Media Click Logic ---
    const mediaModal = document.getElementById('mediaModal');
    const mediaContainer = document.getElementById('modalMediaContainer');
    const mediaClose = document.getElementById('modalClose');

    document.querySelectorAll('.clickable-media').forEach(media => {
        media.style.cursor = 'pointer';
        media.addEventListener('click', () => {
            const type = media.getAttribute('data-type');
            const src = media.getAttribute('data-src');

            mediaContainer.innerHTML = '';

            if (type === 'image') {
                const img = document.createElement('img');
                img.src = src;
                img.style.maxWidth = '100%';
                mediaContainer.appendChild(img);
            } else if (type === 'video') {
                const video = document.createElement('video');
                video.src = src;
                video.controls = true;
                video.autoplay = true;
                video.style.maxWidth = '100%';
                mediaContainer.appendChild(video);
            }

            mediaModal.style.display = 'flex';
        });
    });

    mediaClose?.addEventListener('click', () => {
        mediaModal.style.display = 'none';
        mediaContainer.innerHTML = '';
    });

    mediaModal?.addEventListener('click', (e) => {
        if (e.target === mediaModal) {
            mediaModal.style.display = 'none';
            mediaContainer.innerHTML = '';
        }
    });
});
</script>
</body>
</html>
